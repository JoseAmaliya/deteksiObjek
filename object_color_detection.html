<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Object & Color Detection Pro - TensorFlow.js</title>

<style>
    body {
        font-family: Arial;
        text-align: center;
        background: #222;
        color: white;
    }
    #video, #canvas {
        border: 2px solid #fff;
        margin-top: 20px;
        width: 640px;
        height: 480px;
    }
    #color-box {
        width: 80px;
        height: 80px;
        margin: 15px auto;
        border: 3px solid white;
        background: black;
    }
    #info {
        margin-top: 10px;
        font-size: 22px;
    }
    #btnSave {
        margin-top: 15px;
        padding: 10px 20px;
        font-size: 18px;
        cursor: pointer;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
</head>

<body>

<h2>Object & Color Detection PRO</h2>

<video id="video" width="640" height="480" autoplay muted></video>
<canvas id="canvas" width="640" height="480"></canvas>

<div id="color-box"></div>
<div id="info">Memuat model...</div>

<button id="btnSave">Simpan Foto</button>

<script>
let video = document.getElementById("video");
let canvas = document.getElementById("canvas");
let ctx = canvas.getContext("2d");
let info = document.getElementById("info");
let colorBox = document.getElementById("color-box");
let btnSave = document.getElementById("btnSave");

let model;
let lastSpokenColor = "";

// =============================================================
// COLOR CLASSIFIER (20+ COLORS)
// =============================================================
function classifyColor(r, g, b) {
    // Normalisasi warna agar lebih akurat
    let max = Math.max(r, g, b);
    let min = Math.min(r, g, b);
    let diff = max - min;

    if (max < 50) return "Hitam";
    if (min > 200) return "Putih";

    if (r > 200 && g < 80 && b < 80) return "Merah";
    if (r > 200 && g > 120 && b < 80) return "Oranye";
    if (r > 230 && g > 230 && b < 80) return "Kuning";
    if (g > 180 && r < 120 && b < 120) return "Hijau";
    if (b > 160 && r < 100 && g < 100) return "Biru";

    if (r > 200 && g < 100 && b > 200) return "Magenta";
    if (g > 200 && b > 200 && r < 100) return "Cyan";

    if (r > 150 && g < 80 && b > 150) return "Ungu";
    if (r > 210 && g < 100 && b > 120) return "Pink";

    if (r > 120 && g > 120 && b > 120) return "Abu-abu";

    if (r > 120 && g > 100 && b < 80) return "Coklat";

    return "Tidak dikenal";
}

// =============================================================
// DETEKSI WARNA AREA TENGAH OBJEK (lebih akurat)
// =============================================================
function detectCenterColor(x, y, w, h) {

    // ambil area 40% tengah objek
    let sx = Math.floor(x + w * 0.3);
    let sy = Math.floor(y + h * 0.3);
    let sw = Math.floor(w * 0.4);
    let sh = Math.floor(h * 0.4);

    let img = ctx.getImageData(sx, sy, sw, sh).data;

    let r = 0, g = 0, b = 0, count = 0;

    for (let i = 0; i < img.length; i += 4) {
        r += img[i];
        g += img[i + 1];
        b += img[i + 2];
        count++;
    }

    r = Math.floor(r / count);
    g = Math.floor(g / count);
    b = Math.floor(b / count);

    return { r, g, b };
}

// =============================================================
// TTS
// =============================================================
function speak(text) {
    let u = new SpeechSynthesisUtterance(text);
    u.lang = "id-ID";
    speechSynthesis.speak(u);
}

// =============================================================
// SAVE PHOTO
// =============================================================
btnSave.onclick = () => {
    let link = document.createElement("a");
    link.download = "deteksi-warna.png";
    link.href = canvas.toDataURL();
    link.click();
};

// =============================================================
// START CAMERA
// =============================================================
async function startCamera() {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;
}

// =============================================================
// MAIN DETECTION LOOP
// =============================================================
async function detectFrame() {
    const predictions = await model.detect(video);
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    predictions.forEach(pred => {
        let [x, y, w, h] = pred.bbox;

        ctx.strokeStyle = "lime";
        ctx.lineWidth = 2;
        ctx.strokeRect(x, y, w, h);

        // AMBIL WARNA TENGAH OBJEK
        let avg = detectCenterColor(x, y, w, h);
        let colorName = classifyColor(avg.r, avg.g, avg.b);

        // preview warna
        colorBox.style.background = `rgb(${avg.r}, ${avg.g}, ${avg.b})`;

        ctx.fillStyle = "lime";
        ctx.font = "16px Arial";
        ctx.fillText(`${pred.class} | ${colorName}`, x, y - 5);

        info.innerHTML = `Objek: <b>${pred.class}</b> | Warna: <b>${colorName}</b>`;

        if (colorName !== lastSpokenColor) {
            speak(`Objek ${colorName} terdeteksi`);
            lastSpokenColor = colorName;
        }
    });

    requestAnimationFrame(detectFrame);
}

// =============================================================
// MAIN
// =============================================================
async function main() {
    await startCamera();
    model = await cocoSsd.load();
    info.innerHTML = "Model siap! Mendeteksi...";
    detectFrame();
}

main();
</script>

</body>
</html>
