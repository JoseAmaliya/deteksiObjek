<script>
let video = document.getElementById("video");
let canvas = document.getElementById("canvas");
let ctx = canvas.getContext("2d");
let info = document.getElementById("info");
let colorBox = document.getElementById("color-box");
let btnSave = document.getElementById("btnSave");

let model;
let lastSpokenColor = "";

// BOOST WARNA
function boost(r, g, b) {
    let factor = 1.6; // saturasi
    r = Math.min(255, r * factor);
    g = Math.min(255, g * factor);
    b = Math.min(255, b * factor);
    return {r, g, b};
}

// CLASSIFIER WARNA
function classifyColor(r, g, b) {

    if (r < 40 && g < 40 && b < 40) return "Hitam";
    if (r > 210 && g > 210 && b > 210) return "Putih";

    if (r > 200 && g < 80 && b < 80) return "Merah";
    if (r > 200 && g > 120 && b < 60) return "Oranye";
    if (r > 230 && g > 230 && b < 80) return "Kuning";

    if (g > 170 && r < 130 && b < 130) return "Hijau";
    if (b > 160 && r < 100 && g < 100) return "Biru";

    if (r > 210 && g < 90 && b > 210) return "Magenta";
    if (g > 180 && b > 180 && r < 100) return "Cyan";

    if (r > 150 && g < 80 && b > 150) return "Ungu";
    if (r > 200 && g < 120 && b > 130) return "Pink";

    if (r > 120 && g > 120 && b > 120) return "Abu-abu";

    if (r > 110 && g > 90 && b < 70) return "Coklat";

    return "Tidak dikenal";
}

// ============================================
// GRID SAMPLING 5Ã—5 (bisa 100% akurat)
// ============================================
function smartColorSampling(x, y, w, h) {

    let samples = [];
    let stepX = w / 6;
    let stepY = h / 6;

    for (let i = 1; i <= 5; i++) {
        for (let j = 1; j <= 5; j++) {

            let px = Math.floor(x + stepX * i);
            let py = Math.floor(y + stepY * j);

            let p = ctx.getImageData(px, py, 1, 1).data;
            samples.push([p[0], p[1], p[2]]);
        }
    }

    let r=0,g=0,b=0;
    samples.forEach(s=>{
        r += s[0];
        g += s[1];
        b += s[2];
    });

    r = Math.floor(r / samples.length);
    g = Math.floor(g / samples.length);
    b = Math.floor(b / samples.length);

    return boost(r, g, b);
}

// ============================================
// CAMERA START
// ============================================
async function startCamera() {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;

    return new Promise(res => {
        video.onloadedmetadata = res;
    });
}

// ============================================
// TTS
// ============================================
function speak(txt) {
    let u = new SpeechSynthesisUtterance(txt);
    u.lang = "id-ID";
    speechSynthesis.speak(u);
}

// ============================================
// SAVE PHOTO
// ============================================
btnSave.onclick = () => {
    let link = document.createElement("a");
    link.download = "deteksi.png";
    link.href = canvas.toDataURL();
    link.click();
};

// ============================================
// DETEKSI
// ============================================
async function detectFrame() {

    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const preds = await model.detect(video);

    preds.forEach(p => {
        let [x,y,w,h] = p.bbox;

        // gambar kotak
        ctx.strokeStyle = "lime";
        ctx.lineWidth = 2;
        ctx.strokeRect(x,y,w,h);

        // sampling warna terbaik
        let avg = smartColorSampling(x,y,w,h);

        let colorName = classifyColor(avg.r, avg.g, avg.b);

        colorBox.style.background = `rgb(${avg.r}, ${avg.g}, ${avg.b})`;

        ctx.fillStyle = "lime";
        ctx.font = "16px Arial";
        ctx.fillText(`${p.class} | ${colorName}`, x, y-5);

        info.innerHTML = `Objek: <b>${p.class}</b> | Warna: <b>${colorName}</b>`;

        if (colorName !== lastSpokenColor) {
            speak(`Objek warna ${colorName} terdeteksi`);
            lastSpokenColor = colorName;
        }
    });

    requestAnimationFrame(detectFrame);
}

// ============================================
// MAIN
// ============================================
async function main() {
    await startCamera();
    ctx.imageSmoothingEnabled = true; // penting!
    model = await cocoSsd.load();
    info.innerHTML = "Model siap!";
    detectFrame();
}

main();
</script>
